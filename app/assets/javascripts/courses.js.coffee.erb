# Classes
class window.GmapManager

	
	@init: (customOptions) ->
		# Set defaults options
		@defaultOptions =
			mapOptions:
				styles: [{"featureType":"landscape","stylers":[{"saturation":-100},{"lightness":60}]},{"featureType":"road.local","stylers":[{"saturation":-100},{"lightness":40},{"visibility":"on"}]},{"featureType":"transit","stylers":[{"saturation":-100},{"visibility":"simplified"}]},{"featureType":"administrative.province","stylers":[{"visibility":"off"}]},{"featureType":"water","stylers":[{"visibility":"on"},{"lightness":30}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ef8c25"},{"lightness":40}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"poi.park","elementType":"geometry.fill","stylers":[{"color":"#b6c54c"},{"lightness":40},{"saturation":-40}]},{}];
				center: new google.maps.LatLng(45.764128, 4.835262)
				zoom: 12
			rendererOptions: 
				map: 'map-canvas'

		# Merge options objects to override defaults ones with passed ones
		@options = $.extend(true, {}, @defaultOptions, customOptions);

		@directionsDisplays = []
		@directionsService = new google.maps.DirectionsService();

		# Draw Map
		@map = new google.maps.Map(document.getElementById(@options.rendererOptions.map), @options.mapOptions)
		@options.rendererOptions.map = @map

	@computeCourse: (list, customOptions, callback_print) ->
		defaultOptions =
			distanceCap: false
			index: 0

		@options.computeOptions = $.extend(true, {}, defaultOptions, customOptions);

		if callback_print
			@callback_print = callback_print
		

		for directionDisplay in @directionsDisplays
			directionDisplay.setDirections({routes: []});

		if list.length
			@totalRequests = list.length
			for course, i in list
				request = @makeRequest(course.start, course.end)
				((i) =>
					@directionsService.route(request, (response, status) =>
						@printRoutes(response, status, i)
					)
				)(i)
			
		else
			@totalRequests = 1
			request = @makeRequest(list.start, list.end)
			@directionsService.route(request, (response, status) =>
				@printRoutes(response, status, 0)
			)
			

	@makeRequest: (from, to) ->
		return request =
			origin: from
			destination: to
			travelMode: google.maps.TravelMode.DRIVING


	@printRoutes: (response, status, i) =>
		console.log response

		if status == google.maps.DirectionsStatus.OK
			route = response.routes[0].legs[0]
			
			@directionsDisplays[i] = new google.maps.DirectionsRenderer(@options.rendererOptions)
			@directionsDisplays[i].setDirections(response);
				
			#console.log @directionsDisplays

			if !@options.computeOptions.distanceCap
				@callback_print(
					status: 'OK'
					route: route
				)
			else
				distanceCheckResult = @distanceCheck(route)
				@callback_print(@distanceCheck(route))
		else
			@callback_print(
				status: 'KO'
				message: "Erreur : trajet impossible à générer, une ou les adresses n'ont pas pû être interpretées."
			)

	@distanceCheck: (route) ->
		if route.distance.value > 50000
			return result = 
				status: 'KO'
				message: "Trajet trop long, une notification sera envoyée à Naveco pour traiter votre demande lorsque vous validerez la course."
		else
			if route.distance.value > 10000
				timePrice = 0.3
				kmPrice = 1.5
			else
				timePrice = 0.3
				kmPrice = 2.5

			return result = 
				status: 'OK'
				route:
					duration: route.duration
					distance: route.distance
					timePrice: timePrice
					kmPrice: kmPrice
					totalPrice: Math.round((timePrice*(route.duration.value/60) + kmPrice*(route.distance.value/1000))*10)/10


	

	@printMarker: (options, icon) ->
		markerOptions =
			map: @map
			icon: @options.iconsOptions[icon]
			position: new google.maps.LatLng(options[0], options[1])

		marker = new google.maps.Marker(markerOptions);
		

$(".courses.edit, .courses.new").ready ->

	# Init 
	stopContainer = $(".stop-container:first").clone()
	stop = stopContainer.find('input')
	stop.val('').attr('value', '')

	init.push ->
		datepickerOptions =
			daysOfWeekDisabled: "6"
			todayHighlight: true

		timepickerOptions =
			minuteStep: 5
			showMeridian: false

		$('.date').datepicker datepickerOptions
		$('.time').timepicker timepickerOptions


	options =
		rendererOptions :
			polylineOptions: {strokeColor:'#01b3aa'}

	$(window).on 'gmap-loaded', ->
		window.GmapManager.init(options)

	# Events
	$("body").on "click", "#add-stops", ->
		stopContainer_tmp = stopContainer.clone()
		$('#stops-list').append(stopContainer_tmp)

	$("body").on "click", ".stop-container .close-btn", ->
		$(this).closest(".stop-container").remove()

	$("body").on "click", "#calculer", ->
		GmapManager.computeCourse(
			{start: $('#course_from').val(), end: $('#course_to').val()}, 
			{distanceCap: true},
			(results)->
				console.log results
				if(results.status == 'OK')
					$('#gcompute-error-display').hide()
					$('#course_computed_distance').val(results.route.distance.text)
					$('#course_computed_duration').val(results.route.duration.text)
					$('#course_computed_price').val(results.route.totalPrice+' €')
				else
					$('#gcompute-error-display').html(results.message).show();
					$('#course_computed_distance').val('#Erreur#')
					$('#course_computed_duration').val('#Erreur#')
					$('#course_computed_price').val('#Erreur#')
		)


$(".static_pages.map").ready ->
	class getterStatus
		@div = $('#select-status-display')
		@status_counter =
			ok: 0
			ko:0
			total:0
		@listLength = 0

		@print: (results) ->
			if results == "NOT_FOUND"
				$('#status-notfound').text('Aucune course trouvée').show();
				$('#status-ok-counter').hide();
				$('#status-ko-counter').hide();
			else
				getterStatus.status_counter.total++

				switch results.status
					when "OK" then getterStatus.status_counter.ok++
					when "KO" then getterStatus.status_counter.ko++
				
				# If loop complete
				if getterStatus.status_counter.total == getterStatus.listLength
					$('#status-notfound').hide();
					$('#status-ok-counter').text(getterStatus.status_counter.ok).show();
					if(getterStatus.status_counter.ko > 0)
						$('#status-ko-counter').text(getterStatus.status_counter.ko).show();
					else
						$('#status-ko-counter').hide();

	class pointsManager
		@infosbulles = []

		@get_workingDrivers: () ->
			$.ajax({
	            url: '/ajax/get_pos',
	            type: "GET",
	            dataType: "json",
	            data: {
	            	type:'LastConnecWorkers',
	            	id_user: 4
	            }
	        }).done((response) =>
	        	@printCars(response);
	        );
		
		@get_currentCourses: (customOptions) ->
			defaultOptions =
				partner_id: 'current'
				status: 2 # In progress

			options = $.extend(true, {}, defaultOptions, customOptions);

			$.ajax(
	            url: '/ajax/get_courses',
	            type: "GET",
	            dataType: "json",
	            data:
	            	partner_id: options.partner_id
	            	status: options.status
	        ).done((response) =>
	        	@printCourses(response);
	        );
		
		@printCars: (list) ->
			for infosbulle in @infosbulles
				infosbulle.close();
			
			for element in list
				position = eval(element.position);

				#options = {
				#    map: map,
				#    position: new google.maps.LatLng(47.6342564, 6.8537913),
				#};
				#infowindow = new google.maps.InfoWindow(options);

				window.GmapManager.printMarker(element, 'car')

			#@infosbulles.push infowindow;
		
		@printCourses: (list) ->
			if list.length > 0
				# console.log list
				startEndsList = []

				for course, i in list
					startEndsList[i] = 
						start: course.from;
						end: course.to;

				getterStatus.listLength = list.length

				getterStatus.status_counter.ok = 0
				getterStatus.status_counter.ko = 0
				getterStatus.status_counter.total = 0

				GmapManager.computeCourse(startEndsList, {}, getterStatus.print)

			else getterStatus.print("NOT_FOUND")



	$(window).on 'gmap-loaded', ->
		options =
			rendererOptions :
				polylineOptions: {strokeColor:'#01b3aa', strokeOpacity: 0.6}
				markerOptions:
					icon:
						url: '<%= image_path("map-marker.png") %>'
						size: new google.maps.Size(30, 25)
						origin: new google.maps.Point(0,0)
						anchor: new google.maps.Point(9, 25)
			iconsOptions :
				car:
					url: '<%= image_path("map-car.png") %>'
					size: new google.maps.Size(26, 22)
					origin: new google.maps.Point(0,0)
					anchor: new google.maps.Point(13, 11)

					
		window.GmapManager.init(options)

		pointsManager.get_workingDrivers()
		pointsManager.get_currentCourses()

	$('#partner-select, #status-select').on 'change', ->
		pointsManager.get_currentCourses(
			partner_id: $('#partner-select').val()
			status: $('#status-select').val()
		);

alert 'coffeeexec ?'