<h2>Récapitulatif mensuel des paiements</h2>
<div class="row">
	<div class="col-md-12">
		<div class="panel">
			<div class="panel-body">
				<form id="select-date" class="form-inline col-xs-12" action="<%= admin_monthly_path %>">
					<%= date_select("recap", "date", {:start_year => 2014, :end_year => Time.new.year, :discard_day => true }, {:class => "form-control"} ) %>
					<button type="submit" class="btn btn-info">Voir</button>
				</form>
				<div class="clearfix"></div>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-md-6">
		<div class="panel">
			<div class="panel-heading">
				<span class="panel-title">Totaux</span>
			</div>
			<div class="list-group">
				<div class="list-group-item"><i class="fa fa-user list-group-icon"></i>Nombre de courses effectuées<span class="text-default text-sm" style="float:right;"><%= @courses.count %></span></div>
				<div class="list-group-item"><i class="fa fa-user list-group-icon"></i>Somme totale des courses (avant codes promos)<span class="text-default text-sm" style="float:right;"><%= @totalPrice.round(2) %> €</span></div>
				<div class="list-group-item"><i class="fa fa-user list-group-icon"></i>Somme totale facturée (après codes promos)<span class="text-default text-sm" style="float:right;"><%= @totalPriceAfterCodes.round(2) %> €</span></div>
				<div class="list-group-item"><i class="fa fa-user list-group-icon"></i>Somme totale redistribuée aux chauffeurs<span class="text-default text-sm" style="float:right;"><%= @totalPartnersShare.round(2) %> €</span></div>
				<div class="list-group-item"><i class="fa fa-user list-group-icon"></i>Somme totale revenant à Naveco<span class="text-default text-sm" style="float:right;"><%= @totalNavecoMargin.round(2) %> €</span></div>
				<span> </span><span><%= @a.to_s %></span> 
			</div>
		</div>
		<div class="panel widget-support-tickets">
			<div class="panel-heading">
				<span class="panel-title">Balance des chauffeurs partenaires</span>
			</div>
			<div class="panel-body">
				<% @partners.each do |partner| %>
					<% unpaidCourses = partner.courses.where("status = ? AND payment_status = ? AND payment_by = ? AND date_when >= ? AND date_when <= ?", Course.statuses[:done], Course.payment_statuses[:not_paid], Course.payment_bies[:partner], @month.beginning_of_month, @month.end_of_month) %>
					<% if unpaidCourses.count > 0 %>
					<div class="ticket">
						<div>
							<span class="label label-danger ticket-label"><%= (unpaidCourses.map {|s| price_afterPromo(s)}.reduce(0, :+)).round(2) %> €</span>
							<a href="<%= admin_partner_path(partner) %>" class="ticket-title"><b><%= partner.name %></b></a>
						</div>
						<% unpaidCourses.each do |course| %>
						<div class="ticket-info">
							Course n°<a href="<%= admin_course_path(course) %>"><b><%= course.id %></b></a> - De <%= course.from %> à <%= course.to %><span class="text-default text-xs" style="float:right;"><%= price_afterPromo(course).round(2) %> €</span>
						</div>
						<% end %>
						<div class="text-right">
							<a href="<%= admin_monthly_pdf_path %>?p=<%= partner.id.to_s %>" class="btn btn-sm">Voir la facture</a>
						</div>
					</div>
					<% end %>
				<% end %>
			</div>
		</div>

		<div class="panel widget-support-tickets">
			<div class="panel-heading">
				<span class="panel-title">Sommes dues par les entreprises clientes</span>
			</div>
			<div class="panel-body">
				<% @companies.each do |company|
					@unpaidCourses2 = company.courses.where("status = ? AND payment_status = ? AND payment_by = ? AND date_when >= ? AND date_when <= ?", Course.statuses[:done], Course.payment_statuses[:not_paid], Course.payment_bies[:company], @month.beginning_of_month, @month.end_of_month)
					if @unpaidCourses2.count > 0 %>
					<div class="ticket">
						<div>
							<span class="label label-danger ticket-label"><%= (@unpaidCourses2.map {|s| price_afterPromo(s)}.reduce(0, :+)).round(2) %> €</span>
							<a href="<%= admin_company_path(company) %>" class="ticket-title"><b><%= company.name %></b></a>
						</div>
						<% @unpaidCourses2.each do |course| %>
						<div class="ticket-info">
							Course n°<a href="<%= admin_course_path(course) %>"><b><%= course.id %></b></a> - De <%= course.from %> à <%= course.to %><span class="text-default text-xs" style="float:right;"><%= price_afterPromo(course).round(2) %> €</span>
						</div>
						<% end %>
					</div>
					<% end %>
				<% end %>
			</div>
		</div>
	</div>
	<div class="col-md-6">
		<div class="panel widget-support-tickets">
			<div class="panel-heading">
				<span class="panel-title">Détails des courses effectuées</span>
			</div>
			<div class="panel-body">
				<% @courses.where("status = ?", Course.statuses[:done]).order('payment_status ASC').each do |course| %>
					<div class="ticket">
						<% if course.payment_status == 'paid' %>
						<span class="label label-success ticket-label">Payée</span>
						<% else %>
						<span class="label label-danger ticket-label">Non payée</span>
						<% end %>
						<a title="Voir la course" href="<%= admin_course_path(course) %>" class="ticket-title">De <b><%= course.from %></b> à <b><%= course.to %></b><span>[#<%= course.id.to_s %>]</span></a>
						<div class="ticket-info">
							Client : <a href="<%= if course.user then admin_user_path(course.user) else "#" end %>"><%= if course.user then build_name(course.user) else "#" end %></a> <%= getDateTime(course) %>
						</div>
						<div class="ticket-info">
							Effectuée par la société <a href="<%= admin_partner_path(course.partner) %>"><%= course.partner.name %></a><span class="text-default text-sm" style="float:right;"><%= price_afterPromo(course).round(2) %> €</span>
						</div>
					</div>
				<% end %>
			</div>
			<div class="panel-footer">
				<% totalUnpaid = 0 %>
				<% @unpaidCourses.each do |course| %>
					<% totalUnpaid += price_afterPromo(course) %>
				<% end %>
				<%= @unpaidCourses.count %> courses non reglées <span class="text-default text-sm" style="float:right;"><%= totalUnpaid.round(2) %> €</span>
			</div>
		</div>
	</div>
</div>